{% extends 'myapp/base.html' %}

{% block title %}My Response History - Survey Management System{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-clock-history"></i> My Response History
                    </h2>
                    <p class="text-muted mb-0">
                        View all your completed survey responses
                    </p>
                </div>
                <a href="{% url 'student_dashboard' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Completed Surveys
                    </h5>
                </div>
                <div class="card-body">
                    {% if page_obj %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Survey Title</th>
                                        <th>Submitted Date</th>
                                        <th>Questions Answered</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for response in page_obj %}
                                        <tr>
                                            <td>
                                                <div>
                                                    <h6 class="mb-0">{{ response.survey.title }}</h6>
                                                    {% if response.survey.description %}
                                                        <small class="text-muted">{{ response.survey.description|truncatewords:10 }}</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="text-muted">
                                                    {{ response.submitted_at|date:"M d, Y" }}<br>
                                                    <small>{{ response.submitted_at|time:"g:i A" }}</small>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ response.answers.count }} / {{ response.survey.questions.count }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if response.is_complete %}
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> Complete
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-warning">
                                                        <i class="bi bi-exclamation-circle"></i> Incomplete
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        onclick="viewResponse({{ response.id }})">
                                                    <i class="bi bi-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if page_obj.has_other_pages %}
                            <nav aria-label="Survey history pagination">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1">&laquo; First</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link">
                                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-clipboard-x display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No responses yet</h5>
                            <p class="text-muted">You haven't completed any surveys yet.</p>
                            <a href="{% url 'student_dashboard' %}" class="btn btn-primary">
                                <i class="bi bi-clipboard-data"></i> View Assigned Surveys
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Details Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> Response Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="responseContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function viewResponse(responseId) {
    const modal = new bootstrap.Modal(document.getElementById('responseModal'));
    
    // Show loading state
    document.getElementById('responseContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading response details...</p>
        </div>
    `;
    modal.show();
    
    // Fetch response details via AJAX
    fetch(`/student/response/${responseId}/details/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch response details');
        }
        return response.json();
    })
    .then(data => {
        // Display the response details
        document.getElementById('responseContent').innerHTML = `
            <div class="response-details">
                <div class="mb-4">
                    <h6 class="text-primary mb-2">
                        <i class="bi bi-clipboard-data"></i> ${data.survey_title}
                    </h6>
                    <div class="row text-muted small">
                        <div class="col-md-6">
                            <i class="bi bi-calendar"></i> Submitted: ${data.submitted_at}
                        </div>
                        <div class="col-md-6">
                            <i class="bi bi-check-circle"></i> Status: 
                            <span class="badge ${data.is_complete ? 'bg-success' : 'bg-warning'}">
                                ${data.is_complete ? 'Complete' : 'Incomplete'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="answers-section">
                    <h6 class="mb-3">
                        <i class="bi bi-question-circle"></i> Your Answers
                    </h6>
                    ${data.answers.map((answer, index) => `
                        <div class="answer-item mb-4 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">Q${index + 1}: ${answer.question_text}</h6>
                                <span class="badge bg-secondary">${answer.question_type.replace('_', ' ').toUpperCase()}</span>
                            </div>
                            
                            <div class="answer-content">
                                ${renderAnswer(answer)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('responseContent').innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                <h5 class="text-danger mt-3">Error Loading Response</h5>
                <p class="text-muted">Unable to load response details. Please try again.</p>
                <button class="btn btn-primary" onclick="viewResponse(${responseId})">
                    <i class="bi bi-arrow-clockwise"></i> Retry
                </button>
            </div>
        `;
    });
}

function renderAnswer(answer) {
    switch(answer.question_type) {
        case 'multiple_choice':
            return `
                <div class="selected-answer">
                    <span class="badge bg-primary fs-6">${answer.answer_value}</span>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Available options:</small>
                    <div class="mt-1">
                        ${answer.question_options.map(option => `
                            <span class="badge bg-light text-dark me-1">${option}</span>
                        `).join('')}
                    </div>
                </div>
            `;
            
        case 'likert_scale':
            return `
                <div class="selected-answer">
                    <span class="badge bg-primary fs-6">${answer.answer_value}</span>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Scale: ${answer.likert_min} - ${answer.likert_max}</small>
                    ${answer.question_options.length > 0 ? `
                        <div class="mt-1">
                            <small class="text-muted">Labels:</small>
                            <div class="mt-1">
                                ${answer.question_options.map((label, index) => `
                                    <span class="badge bg-light text-dark me-1">${answer.likert_min + index}: ${label}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
        case 'short_answer':
        case 'long_answer':
            return `
                <div class="text-answer">
                    <div class="p-3 bg-light rounded">
                        ${answer.answer_value || '<em class="text-muted">No answer provided</em>'}
                    </div>
                </div>
            `;
            
        default:
            return `<p class="text-muted">Unknown answer type</p>`;
    }
}
</script>
{% endblock %}
