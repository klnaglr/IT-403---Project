{% extends 'myapp/base.html' %}

{% block title %}{{ survey.title }} - Analytics{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        min-height: 400px;
        transition: transform 0.2s ease-in-out;
    }
    .analytics-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .word-cloud-container {
        height: 300px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .stats-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .stats-card.info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .stats-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .real-time-indicator {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    .section-progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
    }
    .section-progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-graph-up"></i> Analytics: {{ survey.title }}
                        <span class="real-time-indicator" id="live-indicator">
                            <i class="bi bi-circle-fill text-success"></i>
                        </span>
                    </h2>
                    <p class="text-muted mb-0">
                        Real-time survey response analytics and visualizations
                        <small class="text-muted">Last updated: <span id="last-updated">Loading...</span></small>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="refreshAnalytics()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <a href="{% url 'survey_responses' survey.id %}" class="btn btn-outline-success">
                        <i class="bi bi-eye"></i> View Responses
                    </a>
                    <a href="{% url 'edit_survey' survey.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit Survey
                    </a>
                    <a href="{% url 'real_time_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-speedometer2"></i> Real-time Dashboard
                    </a>
                    <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Overview Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Responses</h6>
                            <h3 class="mb-0" id="total-responses">{{ total_responses }}</h3>
                            <small class="opacity-75">All time</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Questions</h6>
                            <h3 class="mb-0" id="total-questions">{{ total_questions }}</h3>
                            <small class="opacity-75">In survey</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-question-circle fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Avg. Completion</h6>
                            <h3 class="mb-0" id="avg-completion">
                                {% if section_stats %}
                                    {% for stat in section_stats %}
                                        {% if forloop.first %}{{ stat.completion_rate }}%{% endif %}
                                    {% endfor %}
                                {% else %}
                                    0%
                                {% endif %}
                            </h3>
                            <small class="opacity-75">Across sections</small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Status</h6>
                            <h6 class="mb-0">
                                {% if survey.is_open %}
                                    <span class="badge bg-light text-success">Active</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">Closed</span>
                                {% endif %}
                            </h6>
                            <small class="opacity-75">
                                {% if survey.due_date %}
                                    Due: {{ survey.due_date|date:"M d, Y" }}
                                {% else %}
                                    No deadline
                                {% endif %}
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-{% if survey.is_open %}play{% else %}pause{% endif %}-circle fs-1 opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Completion Rates -->
    {% if section_stats %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart"></i> Section Completion Rates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for stat in section_stats %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h6 class="mb-0">{{ stat.section.name }}</h6>
                                    <small class="text-muted">{{ stat.section.code }}</small>
                                </div>
                                <div class="text-end">
                                    <strong>{{ stat.completion_rate }}%</strong>
                                    <br>
                                    <small class="text-muted">{{ stat.responses_received }}/{{ stat.total_students }}</small>
                                </div>
                            </div>
                            <div class="section-progress">
                                <div class="section-progress-bar bg-{% if stat.completion_rate >= 80 %}success{% elif stat.completion_rate >= 50 %}warning{% else %}danger{% endif %}" 
                                     style="width: {{ stat.completion_rate }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Question Analytics -->
    <div class="row">
        {% for data in analytics_data %}
            <div class="col-lg-6 mb-4">
                <div class="card analytics-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-question-circle"></i> 
                            Question {{ forloop.counter }}
                        </h5>
                        <div>
                            <span class="badge bg-info">{{ data.question.get_question_type_display }}</span>
                            {% if data.question.is_required %}
                                <span class="badge bg-danger">Required</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title mb-3">{{ data.question.question_text }}</h6>

                        {% if data.question.question_type == 'multiple_choice' %}
                            <!-- Multiple Choice Chart -->
                            <div class="chart-container">
                                <canvas id="chart{{ forloop.counter }}" width="400" height="300"></canvas>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Option</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for choice, stats in data.stats.items %}
                                            <tr>
                                                <td><strong>{{ choice }}</strong></td>
                                                <td>{{ stats.count }}</td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                            <div class="progress-bar" style="width: {{ stats.percentage }}%"></div>
                                                        </div>
                                                        <span class="fw-bold">{{ stats.percentage }}%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                        {% elif data.question.question_type == 'likert_scale' %}
                            <!-- Likert Scale Chart -->
                            <div class="chart-container">
                                <canvas id="chart{{ forloop.counter }}" width="400" height="300"></canvas>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Scale Value</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for value, stats in data.stats.items %}
                                            <tr>
                                                <td><strong>{{ value }}</strong></td>
                                                <td>{{ stats.count }}</td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                            <div class="progress-bar bg-info" style="width: {{ stats.percentage }}%"></div>
                                                        </div>
                                                        <span class="fw-bold">{{ stats.percentage }}%</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                        {% elif data.question.question_type in 'short_answer,long_answer' %}
                            <!-- Text Responses with Word Cloud -->
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="bi bi-cloud"></i> Word Cloud
                                    </h6>
                                    {% if data.word_cloud_data %}
                                        <div class="word-cloud-container" id="wordcloud{{ forloop.counter }}"></div>
                                    {% else %}
                                        <div class="word-cloud-container d-flex align-items-center justify-content-center">
                                            <p class="text-muted mb-0">No text data available</p>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">
                                        <i class="bi bi-chat-text"></i> Individual Responses
                                    </h6>
                                    {% if data.responses %}
                                        <div class="max-height-300 overflow-auto">
                                            {% for response in data.responses %}
                                                <div class="border-bottom pb-2 mb-2">
                                                    <small class="text-muted">Response {{ forloop.counter }}:</small>
                                                    <p class="mb-1">{{ response }}</p>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-muted">No responses yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-graph-up display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">No questions to analyze</h5>
                        <p class="text-muted">Add questions to your survey to see analytics.</p>
                        <a href="{% url 'edit_survey' survey.id %}" class="btn btn-primary">
                            <i class="bi bi-plus"></i> Add Questions
                        </a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Word Cloud Library -->
<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/dist/wordcloud2.min.js"></script>

<script>
let charts = {};
let wordClouds = {};
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page loaded');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    console.log('WordCloud available:', typeof WordCloud !== 'undefined');
    console.log('Analytics data:', {{ analytics_data|safe }});
    
    initializeCharts();
    initializeWordClouds();
    startRealTimeUpdates();
});

function initializeCharts() {
    {% for data in analytics_data %}
        {% if data.question.question_type == 'multiple_choice' %}
            try {
                const ctx{{ forloop.counter }} = document.getElementById('chart{{ forloop.counter }}');
                if (ctx{{ forloop.counter }}) {
                    const chartContext = ctx{{ forloop.counter }}.getContext('2d');
                    charts['chart{{ forloop.counter }}'] = new Chart(chartContext, {
                        type: 'pie',
                        data: {
                            labels: [
                                {% for choice, stats in data.stats.items %}
                                    '{{ choice|escapejs }}'{% if not forloop.last %},{% endif %}
                                {% endfor %}
                            ],
                            datasets: [{
                                data: [
                                    {% for choice, stats in data.stats.items %}
                                        {{ stats.count }}{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ],
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                                    '#00f2fe', '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing chart {{ forloop.counter }}:', error);
            }
        {% elif data.question.question_type == 'likert_scale' %}
            try {
                const ctx{{ forloop.counter }} = document.getElementById('chart{{ forloop.counter }}');
                if (ctx{{ forloop.counter }}) {
                    const chartContext = ctx{{ forloop.counter }}.getContext('2d');
                    charts['chart{{ forloop.counter }}'] = new Chart(chartContext, {
                        type: 'bar',
                        data: {
                            labels: [
                                {% for value, stats in data.stats.items %}
                                    '{{ value|escapejs }}'{% if not forloop.last %},{% endif %}
                                {% endfor %}
                            ],
                            datasets: [{
                                label: 'Responses',
                                data: [
                                    {% for value, stats in data.stats.items %}
                                        {{ stats.count }}{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ],
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2,
                                borderRadius: 4,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed.y;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} responses (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing chart {{ forloop.counter }}:', error);
            }
        {% endif %}
    {% endfor %}
}

function initializeWordClouds() {
    {% for data in analytics_data %}
        {% if data.question.question_type in 'short_answer,long_answer' and data.word_cloud_data %}
            try {
                const wordCloudData{{ forloop.counter }} = {{ data.word_cloud_data|safe }};
                if (wordCloudData{{ forloop.counter }} && wordCloudData{{ forloop.counter }}.length > 0) {
                    const container{{ forloop.counter }} = document.getElementById('wordcloud{{ forloop.counter }}');
                    if (container{{ forloop.counter }} && typeof WordCloud !== 'undefined') {
                        wordClouds['wordcloud{{ forloop.counter }}'] = WordCloud(container{{ forloop.counter }}, {
                            list: wordCloudData{{ forloop.counter }},
                            weightFactor: 8,
                            fontFamily: 'Arial, sans-serif',
                            color: function() {
                                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                                return colors[Math.floor(Math.random() * colors.length)];
                            },
                            rotateRatio: 0.3,
                            rotationAngles: [-90, 0, 90],
                            gridSize: 8,
                            drawOutOfBound: false,
                            shrinkToFit: true,
                            backgroundColor: 'transparent'
                        });
                    }
                }
            } catch (error) {
                console.error('Error initializing word cloud {{ forloop.counter }}:', error);
            }
        {% endif %}
    {% endfor %}
}

function startRealTimeUpdates() {
    // Update every 30 seconds
    refreshInterval = setInterval(refreshAnalytics, 30000);
}

function refreshAnalytics() {
    fetch(`{% url 'analytics_api' survey.id %}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                updateDashboard(data.data);
                updateLastUpdated(data.data.last_updated);
            } else {
                console.error('API returned error:', data.error);
                document.getElementById('live-indicator').innerHTML = '<i class="bi bi-circle-fill text-warning"></i>';
            }
        })
        .catch(error => {
            console.error('Error refreshing analytics:', error);
            document.getElementById('live-indicator').innerHTML = '<i class="bi bi-circle-fill text-danger"></i>';
        });
}

function updateDashboard(data) {
    try {
        // Update statistics
        const totalResponsesEl = document.getElementById('total-responses');
        const totalQuestionsEl = document.getElementById('total-questions');
        
        if (totalResponsesEl) totalResponsesEl.textContent = data.total_responses;
        if (totalQuestionsEl) totalQuestionsEl.textContent = data.total_questions;
        
        // Update charts with new data
        if (data.analytics_data && Array.isArray(data.analytics_data)) {
            data.analytics_data.forEach((questionData, index) => {
                const chartId = `chart${index + 1}`;
                if (charts[chartId] && questionData.chart_data) {
                    try {
                        charts[chartId].data.labels = questionData.chart_data.labels;
                        charts[chartId].data.datasets[0].data = questionData.chart_data.data;
                        charts[chartId].update();
                    } catch (error) {
                        console.error(`Error updating chart ${chartId}:`, error);
                    }
                }
                
                // Update word clouds
                const wordCloudId = `wordcloud${index + 1}`;
                if (wordClouds[wordCloudId] && questionData.word_cloud_data) {
                    try {
                        const container = document.getElementById(wordCloudId);
                        if (container && questionData.word_cloud_data.length > 0 && typeof WordCloud !== 'undefined') {
                            container.innerHTML = '';
                            wordClouds[wordCloudId] = WordCloud(container, {
                                list: questionData.word_cloud_data,
                                weightFactor: 8,
                                fontFamily: 'Arial, sans-serif',
                                color: function() {
                                    const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe'];
                                    return colors[Math.floor(Math.random() * colors.length)];
                                },
                                rotateRatio: 0.3,
                                rotationAngles: [-90, 0, 90],
                                gridSize: 8,
                                drawOutOfBound: false,
                                shrinkToFit: true,
                                backgroundColor: 'transparent'
                            });
                        }
                    } catch (error) {
                        console.error(`Error updating word cloud ${wordCloudId}:`, error);
                    }
                }
            });
        }
        
        // Update live indicator
        const liveIndicator = document.getElementById('live-indicator');
        if (liveIndicator) {
            liveIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
        }
    } catch (error) {
        console.error('Error updating dashboard:', error);
    }
}

function updateLastUpdated(timestamp) {
    const date = new Date(timestamp);
    const timeString = date.toLocaleTimeString();
    document.getElementById('last-updated').textContent = timeString;
}

// Clean up interval when page is unloaded
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}
